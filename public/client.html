<!DOCTYPE html>
<html>
  <head>
    <title>Auto Voting (Client Side Test)</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #status {
        margin: 20px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ระบบโหวตอัตโนมัติ (ทดสอบ Client Side)</h1>
    <div class="debug-info">
      <strong>User Agent ของคุณ:</strong>
      <div id="userAgent"></div>
    </div>
    <button id="testButton" onclick="testRequest()">ทดสอบ Request</button>
    <button id="voteButton" onclick="vote()">โหวต 1 ครั้ง</button>
    <button id="autoVoteButton" onclick="toggleAutoVote()">
      เริ่มโหวตอัตโนมัติ
    </button>
    <div id="status">รอการทำงาน...</div>

    <script>
      let isAutoVoting = false;
      let autoVoteInterval;

      // แสดง User Agent ปัจจุบัน
      document.getElementById("userAgent").textContent = navigator.userAgent;

      async function testRequest() {
        const status = document.getElementById("status");
        try {
          status.textContent = "กำลังทดสอบ request...";

          // ทดสอบ get n value
          const timestamp = Date.now();
          const url = `https://poll.fm/n/31ca8bcfb9002a437240cfd87e440570/14790988?${timestamp}`;

          // ลองตั้ง custom headers
          const config = {
            headers: {
              //   "User-Agent": "Custom User Agent (Test)",
              Accept:
                "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
              "Accept-Language": "en-US,en;q=0.5",
            },
          };

          const response = await axios.get(url, config);

          status.textContent = "ผลการทดสอบ:\n\n";
          status.textContent += `Status: ${response.status}\n`;
          status.textContent += `Headers ที่ส่ง:\n${JSON.stringify(
            config.headers,
            null,
            2
          )}\n\n`;
          status.textContent += `Headers ที่ได้รับ:\n${JSON.stringify(
            response.headers,
            null,
            2
          )}`;
        } catch (error) {
          status.textContent = `เกิดข้อผิดพลาด:\n${error.message}\n\n`;
          if (error.response) {
            status.textContent += `Status: ${error.response.status}\n`;
            status.textContent += `Headers: ${JSON.stringify(
              error.response.headers,
              null,
              2
            )}`;
          }
        }
      }

      async function vote() {
        const button = document.getElementById("voteButton");
        const status = document.getElementById("status");

        try {
          button.disabled = true;
          status.textContent = "กำลังโหวต...";

          const baseFetchURL =
            "https://polls.polldaddy.com/vote-js.php?p=14790988&b=0&a=65657660,&o=&va=16&cookie=0&tags=14790988-src:poll-oembed-simple&n=";

          // ขั้นตอนเหมือนเดิม แต่ทำใน client
          const timestamp = Date.now();
          const url = `https://poll.fm/n/31ca8bcfb9002a437240cfd87e440570/14790988?${timestamp}`;

          const nResponse = await axios.get(url);
          const nMatch = nResponse.data.match(/PDV_n\d+=\'(.*?)\'/);

          if (!nMatch || !nMatch[1]) throw new Error("ไม่พบค่า n ที่ต้องการ");
          const n = nMatch[1];

          const fetchURL = `${baseFetchURL}${n}&url=https%3A//www.thaiupdate.info/female-star-of-the-year-group-2/`;
          const mathsResponse = await axios.get(fetchURL);
          const mathsHTML = mathsResponse.data;

          const mathsKeyMatch = mathsHTML.match(
            /maths_key" value="([a-f0-9]+)"/
          );
          const questionMatch = mathsHTML.match(
            /<p>(\d+\s*\+\s*\d+)\s*=\s*<\/p>/
          );

          if (!mathsKeyMatch || !questionMatch)
            throw new Error("ไม่พบข้อมูล Math Test");
          const mathsKey = mathsKeyMatch[1];
          const question = questionMatch[1];
          const answer = eval(question.replace(/\s+/g, ""));

          const voteURL = `${baseFetchURL}${n}&url=https%3A//www.thaiupdate.info/female-star-of-the-year-group-2/&maths=1&answer=${encodeURIComponent(
            answer
          )}&maths_key=${encodeURIComponent(mathsKey)}`;
          const voteResponse = await axios.get(voteURL);

          if (voteResponse.data.includes("Thank you for voting!")) {
            const match = voteResponse.data.match(/Chiquita[^(]+\((\d+,\d+)/);
            const votes = match ? match[1] : "N/A";
            status.textContent = `โหวตสำเร็จ! จำนวนโหวตปัจจุบัน: ${votes}`;
          } else {
            throw new Error("การโหวตล้มเหลว - ไม่สามารถส่งได้");
          }
        } catch (error) {
          status.textContent = `การโหวตล้มเหลว: ${error.message}`;
        } finally {
          button.disabled = false;
        }
      }

      function toggleAutoVote() {
        const autoButton = document.getElementById("autoVoteButton");
        const status = document.getElementById("status");

        if (!isAutoVoting) {
          isAutoVoting = true;
          autoButton.textContent = "หยุดโหวตอัตโนมัติ";
          status.textContent = "เริ่มโหวตอัตโนมัติ...";

          // โหวตทุก 10 วินาที
          autoVoteInterval = setInterval(vote, 10000);
          vote(); // เริ่มโหวตทันที
        } else {
          isAutoVoting = false;
          autoButton.textContent = "เริ่มโหวตอัตโนมัติ";
          status.textContent = "หยุดโหวตอัตโนมัติแล้ว";
          clearInterval(autoVoteInterval);
        }
      }
    </script>
  </body>
</html>
